name: Build and Test Polarity
run-name: ${{github.actor}} updated Polarity
on:
  push:
    paths:
      - 'polarity/**'
      - 'test/polarity_package_test.go'
      - '.github/workflows/polarity.yaml'
    tags-ignore: ["v**"]
    branches: ['**']

permissions:
  id-token: write
  contents: read
  packages: write

env:
  component: "polarity"

jobs:
  lint:
    uses: ./.github/workflows/lint.yaml
    with:
      component: "polarity"

  rebuild-everything:
    needs: [lint]
    uses: ./.github/workflows/rebuild-everything.yaml
    secrets: inherit

  test-polarity:
    needs: [rebuild-everything]
    runs-on: [self-hosted, onprem]

    steps:
      - name: Set up license file
        run:
          echo "${{ secrets.POLARITY_LICENSE }}" >> /tmp/polarity.lic

      - name: GHCR Login
        uses: docker/login-action@65b78e6e13532edd9afa3aa52ac7964289d1a9c1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: '^1.19.5'
          cache: true
  
      - name: Install dependencies for terratest
        run: |
          go get -t ./...
  
      - name: Run go test
        working-directory: ./test/
        run: |
          go test -timeout 45m     
        
      - name: Remove license file
        if: always()
        run:
          rm -f /tmp/polarity.lic
