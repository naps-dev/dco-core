name: Build and Test XSoar
run-name: ${{github.actor}} updated XSoar
on:
  push:
    paths:
      - 'xsoar/**'
      - 'test/xsoar_package_test.go'
      - '.github/workflows/xsoar.yaml'
    tags-ignore: ["v**"]
    branches: ['**']

permissions:
  id-token: write
  contents: read
  packages: write

env:
  component: "xsoar"

jobs:
  lint:
    uses: ./.github/workflows/lint.yaml
    with:
      component: "xsoar"

  rebuild-everything:
    needs: [lint]
    uses: ./.github/workflows/rebuild-everything.yaml
    secrets: inherit

  test-xsoar:
    needs: [lint]
    runs-on: [self-hosted, onprem]

    steps:
      - name: Login to XSOAR registry
        run: |
          zarf tools registry login \
            -u "${{secrets.XSOAR_USERNAME}}" \
            -p "${{secrets.XSOAR_PASSWORD}}" \
            "xsoar-registry.pan.dev"

      - name: Set up license file
        run:
          echo "${{ secrets.XSOAR_LICENSE }}" >> /tmp/demisto.lic

      - name: GHCR Login
        uses: docker/login-action@65b78e6e13532edd9afa3aa52ac7964289d1a9c1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: '^1.19.5'
          cache: true
  
      - name: Install dependencies for terratest
        run: |
          go get -t ./...
  
      - name: Run go test
        working-directory: ./test/
        run: |
          go test -timeout 45m

      - name: Cleanup XSOAR license
        if: always()
        run:
          rm -f /tmp/demisto.lic
